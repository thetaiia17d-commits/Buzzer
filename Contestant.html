<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Thí sinh</title>
  <style>
    /* Giữ nguyên CSS cũ */
    body {
      font-family: Arial, sans-serif;
      background: #eef;
      text-align: center;
      padding: 20px;
      user-select: none;
    }

    input,
    textarea {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      font-weight: bold;
      user-select: text;
    }

    textarea {
      width: 80%;
      max-width: 1000px;
      height: 100px;
      resize: none;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .textarea-locked {
      background-color: #333 !important;
      color: #fff !important;
      border: 2px solid #000;
      caret-color: transparent;
      outline: none;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      color: white;
      border: none;
      font-weight: bold;
    }

    #gameArea {
      display: none;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
      min-height: 300px;
    }

    #btnJoin {
      background: purple;
      color: white;
      font-weight: bold;
      height: 40px;
      padding: 10px 20px;
      font-size: 16px;
    }

    #btnJoin:hover {
      background: orange;
    }

    #btnSend,
    #btnBuzz {
      width: 80%;
      max-width: 1000px;
      height: 100px;
      margin-top: 5px;
      font-size: 25px;
    }

    #btnSend {
      background: yellow;
      color: black;
    }

    #btnBuzz {
      background: blue;
    }

    .locked {
      background: black !important;
      color: white !important;
      cursor: not-allowed;
      opacity: 1;
    }

    #btnSend:not(.locked):hover,
    #btnBuzz:not(.locked):hover {
      background: orange !important;
      color: white !important;
      font-weight: bold;
    }

    #popupMessage {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: red;
      color: white;
      padding: 15px 30px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.5s, top 0.5s;
      font-weight: bold;
      z-index: 1000;
    }

    .error {
      background-color: red;
    }

    .timer-info {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .timer-countdown {
      color: red;
      font-size: 2.5em;
      font-family: monospace;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <h1>Thí sinh</h1>
  <input id="roomCode" placeholder="Mã phòng">
  <input id="name" placeholder="Tên của bạn">
  <button id="btnJoin">Xác nhận</button>

  <div id="gameArea">
    <div class="timer-info">Thời gian gửi đáp án: <span id="answerCountdown" class="timer-countdown">--.--s</span>
    </div>
    <div class="timer-info">Thời gian bấm chuông: <span id="buzzCountdown" class="timer-countdown">--.--s</span>
    </div>
    <textarea id="answer" placeholder="Nhập đáp án..."></textarea>
    <button id="btnSend">Gửi đáp án</button>
    <button id="btnBuzz">Bấm chuông</button>
  </div>
  <div id="popupMessage"></div>

  <script>
    // --- CẤU HÌNH SUPABASE ---
    var SUPABASE_URL = "https://rsvggeknetiacezwvgxy.supabase.co";
    var SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzdmdnZWtuZXRpYWNlend2Z3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0OTI0NzksImV4cCI6MjA4MDA2ODQ3OX0.mkrHJaOA2axmVx8o5M0AOoyiVdmIFyNdQMiQahSvdEU";
    var supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myRoom = "";
    let myName = "";
    let lockedAnswer = true;
    let lockedBuzz = true;
    let hasBuzzed = false;
    let answerInterval = null;
    let buzzInterval = null;
    let roomChannel = null;
    let serverTimeOffset = 0;

    const btnSend = document.getElementById("btnSend");
    const btnBuzz = document.getElementById("btnBuzz");
    const answerTextArea = document.getElementById("answer");
    const roomCodeInput = document.getElementById("roomCode");
    const nameInput = document.getElementById("name");
    const btnJoin = document.getElementById("btnJoin");
    const gameArea = document.getElementById("gameArea");

    function showPopup(msg, type = "success") {
      const p = document.getElementById("popupMessage");
      p.innerText = msg;
      p.className = type === "error" ? "error" : "";
      p.style.opacity = "1";
      p.style.top = "40px";
      setTimeout(() => {
        p.style.opacity = "0";
        p.style.top = "20px";
      }, 3000);
    }

    function updateAnswerUI(isLocked) {
      lockedAnswer = isLocked;
      btnSend.disabled = isLocked;
      answerTextArea.readOnly = isLocked;
      if (isLocked) {
        btnSend.classList.add("locked");
        answerTextArea.classList.add("textarea-locked");
      } else {
        btnSend.classList.remove("locked");
        answerTextArea.classList.remove("textarea-locked");
        answerTextArea.focus();
      }
    }

    function updateBuzzUI(isGloballyLocked) {
      lockedBuzz = isGloballyLocked;
      if (isGloballyLocked || hasBuzzed) {
        btnBuzz.classList.add("locked");
        btnBuzz.disabled = true;
      } else {
        btnBuzz.classList.remove("locked");
        btnBuzz.disabled = false;
      }
    }

    function getServerTimeNow() {
      // Thời gian ước tính của Server (Đã đồng bộ)
      return Date.now() + serverTimeOffset; 
    }

    async function syncServerTime() {
      if (!myRoom) return;
      const tempName = "SYNC_TIME_" + Math.random();
      const { data } = await supabase.from('participants')
        .insert([{ room_code: myRoom, name: tempName, role: 'contestant' }])
        .select().single();

      if (data) {
        const serverTs = new Date(data.created_at).getTime();
        const localTs = Date.now();
        serverTimeOffset = serverTs - localTs;
        await supabase.from('participants').delete().eq('id', data.id);
      }
    }

    // --- XỬ LÝ ĐỒNG HỒ ĐẾM NGƯỢC ---
    function startTimer(elementId, startTimeISO, duration, callbackEnd) {
      const el = document.getElementById(elementId);
      if (elementId === 'answerCountdown' && answerInterval) clearInterval(answerInterval);
      if (elementId === 'buzzCountdown' && buzzInterval) clearInterval(buzzInterval);

      if (!startTimeISO) {
        el.innerText = "--.--s";
        return;
      }
      
      if (duration <= 0) {
        el.innerText = "--.--s";
        return;
      }

      const sharedStartTime = new Date(startTimeISO).getTime();
      const localEndTime = sharedStartTime + (duration * 1000);
      
      const now = getServerTimeNow();
      let initialRemain = localEndTime - now;
      initialRemain = initialRemain > 0 ? initialRemain : 0;
      el.innerText = (initialRemain / 1000).toFixed(3) + "s";
      
      const interval = setInterval(() => {
        const currentNow = getServerTimeNow();
        let remain = localEndTime - currentNow;

        if (remain <= 0) {
          clearInterval(interval);
          el.innerText = "0.000s";
          if (callbackEnd) callbackEnd();
        } else {
          el.innerText = (remain / 1000).toFixed(3) + "s";
        }
      }, 30);

      if (elementId === 'answerCountdown') answerInterval = interval;
      if (elementId === 'buzzCountdown') buzzInterval = interval;
    }

    // --- THAM GIA PHÒNG ---
    btnJoin.onclick = async () => {
      const codeString = roomCodeInput.value.trim();
      const name = nameInput.value.trim();

      if (!codeString || !name || codeString.length !== 6 || isNaN(parseInt(codeString))) 
        return showPopup("Mã phòng hoặc Tên không hợp lệ", "error");

      const code = parseInt(codeString);

      const { data: room, error: roomError } = await supabase.from('rooms').select('*').eq('room_code', code).single();
      if (roomError || !room) return showPopup("Phòng không tồn tại!", "error");

      const { error: insertError } = await supabase.from('participants').insert([{
        room_code: code,
        name: name,
        role: 'contestant'
      }]);

      if (insertError) {
        if (insertError.code === '23505' || insertError.message.includes('duplicate')) {
          const { data: existingUser } = await supabase
            .from('participants')
            .select('role')
            .eq('room_code', code)
            .eq('name', name)
            .single();

          if (existingUser && existingUser.role === 'contestant') {
            showPopup("Chào mừng bạn quay lại!");
          } else {
            return showPopup("Tên này đã được Ban tổ chức sử dụng!", "error");
          }
        } else {
          return showPopup("Lỗi tham gia: " + insertError.message, "error");
        }
      } else {
        showPopup("Đã vào phòng " + code);
      }

      myRoom = code;
      myName = name;

      gameArea.style.display = "flex";
      roomCodeInput.disabled = true;
      nameInput.disabled = true;
      btnJoin.disabled = true;

      await syncServerTime();
      handleRoomUpdate(room);
      subscribeRealtime();
    };

    function subscribeRealtime() {
      if (roomChannel) supabase.removeChannel(roomChannel);

      roomChannel = supabase.channel('room-' + myRoom, { config: { presence: { key: myName } } });

      roomChannel
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `room_code=eq.${myRoom}` },
          (payload) => handleRoomUpdate(payload.new))

        .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'answers', filter: `room_code=eq.${myRoom}` },
          () => { answerTextArea.value = ""; showPopup("Host đã reset đáp án!"); })

        .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'buzzes', filter: `room_code=eq.${myRoom}` },
          () => { hasBuzzed = false; updateBuzzUI(lockedBuzz); showPopup("Host đã reset chuông!"); })

        .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'participants', filter: `room_code=eq.${myRoom}` },
          (payload) => {
            if (payload.old.name === myName) {
              location.reload(); 
            }
          })

        .subscribe(async (status) => {
          if (status === 'SUBSCRIBED') {
            const { error } = await roomChannel.track({
              name: myName,
              role: 'contestant',
              online_at: new Date().toISOString()
            });
            if (error) console.error("Error tracking presence:", error);
          }
        });
    }

    async function handleRoomUpdate(roomData) {
      if (roomData.answer_status === 'pending_open') {
        const start_time_iso = new Date(getServerTimeNow()).toISOString();
        const duration = roomData.answer_duration;
        
        await supabase.from('rooms').update({
          answer_status: 'open',
          answer_open_time: start_time_iso
        }).eq('room_code', myRoom);

        updateAnswerUI(false);
        startTimer('answerCountdown', start_time_iso, duration, () => {
          updateAnswerUI(true);
        });
        
      } else if (roomData.answer_status === 'open') {
        updateAnswerUI(false);
        startTimer('answerCountdown', roomData.answer_open_time, roomData.answer_duration, () => {
          updateAnswerUI(true);
        });
      } else { 
        updateAnswerUI(true);
        document.getElementById('answerCountdown').innerText = "0.000s";
        if (answerInterval) clearInterval(answerInterval);
      }

      if (roomData.buzz_status === 'pending_open') {
        const start_time_iso = new Date(getServerTimeNow()).toISOString();
        const duration = roomData.buzz_duration;
        hasBuzzed = false;
        
        await supabase.from('rooms').update({
          buzz_status: 'open',
          buzz_open_time: start_time_iso
        }).eq('room_code', myRoom);

        updateBuzzUI(false);
        startTimer('buzzCountdown', start_time_iso, duration, () => {
          updateBuzzUI(true);
        });

      } else if (roomData.buzz_status === 'open') {
        updateBuzzUI(false);
        startTimer('buzzCountdown', roomData.buzz_open_time, roomData.buzz_duration, () => {
          updateBuzzUI(true);
        });
      } else { 
        updateBuzzUI(true);
        document.getElementById('buzzCountdown').innerText = "0.000s";
        if (buzzInterval) clearInterval(buzzInterval);
      }
    }

    // --- GỬI ĐÁP ÁN (ĐÃ SỬA: Gửi kèm Client Time) ---
    btnSend.onclick = async () => {
      if (lockedAnswer) return showPopup("Đang khóa!", "error");
      const text = answerTextArea.value.trim();
      if (!text) return showPopup("Nhập đáp án!", "error");

      // 1. Chặn UI ngay lập tức
      btnSend.disabled = true; 
      showPopup("Đang gửi..."); 
      
      // 2. Lấy thời gian đồng bộ ngay thời điểm bấm (Client Time)
      const clientTimeISO = new Date(getServerTimeNow()).toISOString();

      answerTextArea.value = "";
      answerTextArea.focus();

      // 3. Gửi 'created_at' thủ công để Host tính toán chính xác
      const { error } = await supabase.from('answers').insert([{
        room_code: myRoom,
        name: myName,
        answer_text: text,
        created_at: clientTimeISO // <--- QUAN TRỌNG: Loại bỏ độ trễ mạng
      }]);

      if (!error) {
        showPopup("Đã gửi!"); 
        btnSend.disabled = false; 
      } else {
        showPopup("Lỗi gửi: " + error.message, "error");
        answerTextArea.value = text; 
        btnSend.disabled = false; 
        console.error("Lỗi gửi đáp án:", error);
      }
    };

    // --- BẤM CHUÔNG (ĐÃ SỬA: Gửi kèm Client Time) ---
    btnBuzz.onclick = async () => {
      if (lockedBuzz || hasBuzzed) return;

      // 1. Chặn UI ngay lập tức
      hasBuzzed = true;
      updateBuzzUI(true);
      showPopup("Đã bấm chuông!");
      
      // 2. Lấy thời gian đồng bộ ngay thời điểm bấm
      const clientTimeISO = new Date(getServerTimeNow()).toISOString();

      // 3. Gửi 'created_at' thủ công
      const { error } = await supabase.from('buzzes').insert([{
        room_code: myRoom,
        name: myName,
        created_at: clientTimeISO // <--- QUAN TRỌNG
      }]);

      if (error) {
        hasBuzzed = false;
        updateBuzzUI(false); 
        showPopup("Lỗi bấm: " + error.message, "error");
        console.error("Lỗi bấm chuông:", error);
      }
    };

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Control') { e.preventDefault(); btnBuzz.click(); }
      if (e.key === 'Enter' && !e.shiftKey && document.activeElement === answerTextArea) {
        e.preventDefault();
        btnSend.click();
      }
    });

    async function leaveRoom() {
      if (!myRoom || !myName) return;
      try {
        await supabase
          .from("participants")
          .delete()
          .eq("room_code", myRoom)
          .eq("name", myName);
      } catch (err) {
        console.warn("Leave room error:", err.message);
      }
    }

    window.addEventListener("beforeunload", () => {
      leaveRoom();
    });
  </script>
</body>

</html>